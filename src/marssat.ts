// The Ephemerides of the Martian satellites
// (adjustement from 1877 to 2005, Version 1.0)
// by Valery Lainey can be obtained from Valery Lainey:

import { DAYSPERJC, DEG2RAD } from './constants'
import { ellipticToRectangularA } from './ephemeris'
import { matMulVec } from './mat3'
import { type Time, tt } from './time'

// V.Lainey (Lainey@oma.be)
// ROB- 3, Avenue Circulaire, B-1180 Bruxelles (Belgium)
// IMCCE - 77, Avenue Denfert-Rochereau 75014 Paris (France)

// Based on https://github.com/Stellarium/stellarium/blob/v25.3/src/core/planetsephems/marssat.c

export type MarsSatTerm = readonly [number, number, number] // phase, frequency, amplitude

export type MarsSatTermList = readonly MarsSatTerm[]

export interface MarsSatBody {
	readonly mu: number
	readonly l: number
	readonly acc: number
	readonly constants: number[]
	readonly list: readonly MarsSatTermList[]
}

const PHOBOS_0: MarsSatTermList = [
	[5.013490350126586, 2.715567382195733e1, 4.537539999999999e-9],
	[6.83991059078e-1, 1.969446151585829e1, 7.312e-10],
	[4.514031245592586, 4.073350897245015e1, 7.785599999999993e-10],
	[5.531351678889586, 1.357783661756435e1, 3.529399999999985e-10],
	[5.700307292822586, 4.685013393001369e1, 2.094599999999994e-10],
	[4.228062220664587, 5.431134764391466e1, 9.139999999999999e-11],
	[1.1679075830175, 7.461211875946264, 6.204e-11],
	[5.197274703601086, 6.042797388545593e1, 5.295999999999951e-11],
	[5.160045430868086, 3.938582310889583e1, 1.811999999999999e-11],
	[2.2232772299005, 5.777452001970681e1, 1.563999999999897e-11],
	[6.921616240614999e-1, 2.103904892768837e1, 1.535999999999999e-11],
	[6.215802752555586, 3.327229783044108e1, 1.304e-11],
	[1.368231494011, 3.93889217970823e1, 1.661999999999999e-11],
	[2.601539199675e-1, 7.446011234647927, 1.328e-11],
	[5.9038456871e-2, 3.941932465627423e1, 8.559999999999978e-12],
	[6.179310844209586, 5.911910805492755e1, 7.24e-12],
]

const PHOBOS_1: MarsSatTermList = [
	[5.334169568271586, 9.145914066599032e-3, 5.01684813e-5],
	[5.334169148295587, 9.145914113327495e-3, 5.01684813e-5],
	[3.80534526596e-1, 1.540952541904328e-3, 3.35026497e-5],
	[3.80533948496e-1, 1.54095261310426e-3, 3.350264903e-5],
	[5.288363718535586, 1.829243888046791e-2, 2.827839093e-5],
	[5.288363809359586, 1.829243887034939e-2, 2.827839093e-5],
	[3.412685718051586, 7.604696023359408e-3, 1.578862428e-5],
	[3.412685998796586, 7.604695992157328e-3, 1.578862427e-5],
	[3.448999855869586, 2.71556761692721e1, 3.00884432e-5],
	[9.194445444030001e-1, 3.101144183892481e-3, 8.178563170000001e-6],
	[9.19444319278e-1, 3.101144208596499e-3, 8.17856334e-6],
	[5.387625479307586, 1.96944627504927e1, 2.044327843999999e-5],
	[2.84899673989, 2.743829098982358e-2, 6.51695172e-6],
	[2.848996748767, 2.743829098862537e-2, 6.51695172e-6],
	[3.954411167839586, 1.357783808463605e1, 1.013316988e-5],
	[2.912659283736, 4.073351425390815e1, 7.48346875999974e-6],
	[4.067858164824586, 2.589727369338346e-2, 2.58935939e-6],
	[4.067857973471586, 2.589727371473152e-2, 2.58935939e-6],
	[3.77627161385e-1, 3.65841782885365e-2, 1.12514742e-6],
	[3.77626798556e-1, 3.658417832900902e-2, 1.12514742e-6],
	[4.121936540919586, 4.685014091671e1, 1.523532599999976e-6],
	[1.231836210236, 1.674957754399965e-2, 4.9765123e-7],
	[1.231836585135, 1.674957750247454e-2, 4.9765123e-7],
	[2.488083095032, 1.52038620787535e-2, 6.8419668e-7],
	[2.488083105051, 1.52038620772819e-2, 6.8419668e-7],
	[1.5761418806595, 3.504321962396548e-2, 1.12486858e-6],
	[6.145328698142587, 6.116624841770791, 7.873411399999999e-7],
	[2.6267561051145, 5.43113523385442e1, 1.04064572e-6],
	[2.759579551372, 7.461213382164448, 7.166789399999994e-7],
	[6.005673273380586, 1.314187651672942, 6.022022799999936e-7],
	[9.3530900566e-2, 7.53211563854622e-4, 1.9649769e-7],
	[9.343265452500001e-2, 7.532237916966188e-4, 1.9649645e-7],
	[4.302928383505e-1, 3.9385825577776e1, 4.9873078e-7],
	[3.587439959397586, 6.042797969706294e1, 4.804827999999994e-7],
	[4.183547650369587, 4.572998195120822e-2, 1.7471331e-7],
	[4.183547815926586, 4.572998193123842e-2, 1.7471331e-7],
	[5.589444380180586, 6.068411018120026e-3, 1.7930767e-7],
	[5.589445119118587, 6.068410936124942e-3, 1.7930768e-7],
	[6.062696336024086, 3.938892673561993e1, 2.653755199999908e-7],
	[4.628882088425586, 3.327230135427769e1, 2.5392728e-7],
	[4.736462571780586, 1.224558395734566e-2, 1.2547154e-7],
	[4.736462588777586, 1.224558396211886e-2, 1.2547155e-7],
]

const PHOBOS_2: MarsSatTermList = [
	[1.404382124885, 7.595588511174286e-3, 1.514110912521e-2],
	[2.088385523034, 1.970205682773437e1, 3.8496208674e-4],
	[3.895377361148586, 1.06967028026819e-2, 6.903413242e-5],
	[4.98957209475e-1, -7.605272825959576e-3, 4.946101994e-5],
	[8.21521022172e-1, 4.685772969905357e1, 3.671320788e-5],
	[3.378076387479586, -7.453616316894914, 3.267983782e-5],
	[2.772375719698, 3.93965187319472e1, 8.75048305e-6],
	[2.839303414769, 6.12422038837152, 6.17093881e-6],
	[3.18450317043e-1, 6.043556479692822e1, 6.95700594e-6],
	[1.410329121503, 1.984322681200531e-2, 5.73408896e-6],
	[1.336796551701, 3.327989343110183e1, 3.43157786e-6],
	[3.853646745987586, -2.103145308554279e1, 4.03740951e-6],
	[2.54706736621e-1, 1.54966559422109e-3, 2.11529622e-6],
	[1.508224230072, -5.911151611514718e1, 1.90482762e-6],
	[3.4626075514e-2, -5.165030141480156e1, 8.696094700000001e-7],
	[3.198655314207586, 9.152774292423818e-3, 6.3298682e-7],
	[5.163954670916587, 1.674080796065678e-2, 6.1303178e-7],
	[7.803937436990001e-1, -1.550610622055567e-3, 5.7372171e-7],
	[3.264588234538586, 2.716326950857758e1, 8.1810883e-7],
	[5.211329429707586, 2.898903518276566e-2, 7.4341453e-7],
	[2.69171676349, -2.71480776901214e1, 5.441647800000001e-7],
	[1.001733960626, -4.553367734785991e1, 5.044515e-7],
	[3.212149602842586, -1.968376490094933e1, 4.2845991e-7],
	[4.145658249560586, -3.46092893218734e1, 4.2249373e-7],
	[5.063879137454586, 2.589097180762378e-2, 3.5819498e-7],
	[2.558639707373, 6.064928432880783e-3, 3.8088812e-7],
	[5.292499025555586, 3.075065445597794e-3, 4.0557392e-7],
]

const PHOBOS_3: MarsSatTermList = [
	[2.058107128488, -7.604861328578004e-3, 9.408605183120001e-3],
	[3.248856489376586, -9.145863467943084e-3, 5.699538102e-5],
	[4.557280987272586, 1.829238959116374e-2, 2.474369483e-5],
	[6.113423353213586, 7.595702278066188e-3, 2.062715397e-5],
	[2.067112903892, 2.743825478464904e-2, 5.94557416e-6],
	[1.700689207004, 9.145729527513899e-3, 3.9201902e-6],
	[3.577059353926586, -1.829259493439447e-2, 2.16779197e-6],
	[4.940284891770586, -7.453616316894914, 2.76976375e-6],
	[2.117885747855, 3.94117189242592e1, 1.81353917e-6],
	[5.17605536523e-1, 1.970205682773437e1, 1.08342918e-6],
	[5.864248782211586, 3.658425999636452e-2, 1.06665701e-6],
	[3.240692168340586, 2.589639535977297e-2, 7.9098533e-7],
	[7.57075199434e-1, -1.321790869500707, 8.880885099999999e-7],
	[6.60891079606e-1, 6.12422038837152, 5.5207589e-7],
	[5.519669134088586, 4.685772969905357e1, 4.397886e-7],
	[5.844000094873587, -2.74382573344411e-2, 4.5836091e-7],
	[4.602755395228586, -1.675516082048598e-2, 3.5331311e-7],
	[2.685649467156, 1.542518910643103e-3, 3.5029885e-7],
	[3.353176877809586, 1.22560458183911e1, 3.8288517e-7],
	[2.556761413073, 1.068971473943851e-2, 2.7112473e-7],
	[4.622369718415587, -2.589682634097252e-2, 1.9917454e-7],
	[7.49769089433e-1, 3.504362063026418e-2, 2.0368977e-7],
	[3.965205602751586, 2.714806830611846e1, 1.7267796e-7],
	[4.743858488241586, -2.103145308554279e1, 1.5744728e-7],
	[3.405870070134586, 4.572380100924578e-2, 1.6985677e-7],
	[3.74238084921e-1, 3.327989343110183e1, 1.0150045e-7],
	[1.374678754422, -1.970206671243377e1, 8.259149000000001e-8],
	[1.140160118874, -6.108652383295211e-3, 8.504923e-8],
]

const DEIMOS_0: MarsSatTermList = [
	[6.146803530569087, 2.294413036846356, 5.39836e-9],
	[3.432805186019586, 9.935735425667586, 7.095199999999997e-10],
	[4.356581106602587, 3.441619555269535, 3.7378e-10],
	[5.915601483397086, 9.926589650598594, 2.3374e-10],
	[1.6152431614465, 1.147206518423178, 1.697e-10],
	[2.114704906116, 9.917443791162608, 5.314e-11],
	[9.393388277920001e-1, 9.954027953247621, 7.046e-11],
	[3.949494792732586, 9.944881541450725, 4.233999999999998e-11],
	[2.0893223919695, 2.29409760669131, 2.813999999999983e-11],
	[7.795571756865e-1, 2.294728469946876, 2.549999999999971e-11],
	[2.3618516696645, 4.588826073692712, 1.676e-11],
	[2.7700268835785, 9.954658773106329, 9.719999999999976e-12],
	[4.733522308629587, 9.963173826265681, 9.519999999999998e-12],
	[3.258781379519086, 1.472506551307767e1, 9.73999999999999e-12],
	[4.596299836113586, 9.90829789432185, 1.027999999999982e-11],
	[3.0576884433465, 2.682916339604879, 6.679999999999999e-12],
	[5.453932177963086, 2.682285947505377, 6.879999999999995e-12],
	[4.328499239462586, 9.936050924435195, 6.199999999999996e-12],
	[2.168321380562, 4.976699000854042, 5.359999999999916e-12],
	[2.516818588675, 9.935420104041299, 3.359999999999995e-12],
	[2.997827070725e-1, 3.441304123224338, 2.919999999999998e-12],
	[2.1431434204625, 2.682600911813873, 2.979999999999999e-12],
	[5.271781540988586, 3.441934988580561, 2.64e-12],
	[5.38228720593e-1, 9.926905039305762, 2.039999999999966e-12],
	[3.629187963751586, 2.303558945733479, 1.09e-12],
]

const DEIMOS_1: MarsSatTermList = [
	[2.488175621789, 3.153377646687549e-4, 2.48303166019e-3],
	[2.488175634463, 3.153377641537758e-4, 2.48303165949e-3],
	[5.336889264964586, 9.145915158660612e-3, 2.0234269782e-4],
	[5.336889346905586, 9.145915155199243e-3, 2.0234269782e-4],
	[5.281538321363586, 1.829244561727392e-2, 1.0431675642e-4],
	[5.281537958522586, 1.829244563271799e-2, 1.0431675643e-4],
	[1.4334900188355, 2.294413045224799, 1.637133774599998e-4],
	[2.8520077883375, 2.743818628432718e-2, 4.82067142e-5],
	[3.147176604035586, 1.860783561096842e-2, 1.497066023e-5],
	[3.147176307034586, 1.860783562364318e-2, 1.497066034e-5],
	[3.182516662993086, 1.147206709032795, 1.137028858e-5],
	[5.917181875408586, 3.44162012081455, 8.350609860000001e-6],
	[3.544871659744586, 6.190897763118658e-4, 4.3832545e-6],
	[3.544871649035586, 6.190897769462623e-4, 4.3832545e-6],
	[4.61419338359e-1, 3.657933964533806e-2, 8.316176420000001e-6],
	[6.75422268593e-1, 2.775277029221846e-2, 6.447587580000001e-6],
	[5.001640850015586, 9.935735582783501, 7.926687400000001e-6],
	[4.485218623803586, 8.828439970895009e-3, 3.90506421e-6],
	[2.22101391798e-1, 9.464721723028089e-3, 3.11780183e-6],
	[4.485218622895586, 8.828439971019056e-3, 3.90506421e-6],
	[2.22101394466e-1, 9.464721722885516e-3, 3.11780183e-6],
]

const DEIMOS_2: MarsSatTermList = [
	[2.198649419514, 3.148401892560942e-4, 2.7441315346e-4],
	[4.366636518977586, 4.977013897776327, 6.015912711e-5],
	[1.46381621037, -3.153164045300449e-4, 3.614585349e-5],
	[1.362467588064, 2.682600831640474, 2.577157903e-5],
	[9.33679289332e-1, -4.958721582505435, 6.80199783e-6],
	[3.152432010349586, 1.535394310272536, 4.45297914e-6],
	[4.734051493918586, -4.949575691510945, 2.23848292e-6],
	[5.736642853342587, 2.32752464933439e-4, 1.47874757e-6],
	[5.084945958505586, 3.912335403634271e-4, 1.45772004e-6],
	[4.232770650771586, 7.271426904652134, 1.34703031e-6],
	[1.516439412109, 1.4912749476923e1, 7.538179100000001e-7],
	[3.100618466711, 1.797748798526167e-2, 8.7162297e-7],
	[5.155432690964586, 3.881877876517008e-1, 1.01564888e-6],
	[2.250768124831, -4.940429834739583, 5.0909893e-7],
	[3.422251338868586, -4.977013897776327, 6.5370775e-7],
]

const DEIMOS_3: MarsSatTermList = [
	[2.981506933511, -3.154811355556041e-4, 1.562693319959e-2],
	[4.557500894366586, 1.829233626168517e-2, 1.3218186311e-4],
	[3.248124065112586, -9.145934570587952e-3, 3.833652719e-5],
	[1.70155133871, 9.14566598660177e-3, 2.660211842e-5],
	[2.067662003165, 2.743821959085702e-2, 2.882438535e-5],
	[4.805327222478586, 3.158564952832469e-4, 2.713213911e-5],
	[2.318788380092, 1.860776219134252e-2, 9.29632495e-6],
	[3.613580709014586, -1.829261290520875e-2, 4.46096029e-6],
	[5.867810550672586, 3.658405181871115e-2, 4.90415603e-6],
	[5.496515547817586, -9.461294099629817e-3, 2.36688115e-6],
	[6.120362957845586, 2.77536106462592e-2, 2.05755285e-6],
	[3.612389208841586, 8.830178627407989e-3, 2.36575014e-6],
	[5.554163001934587, -1.860800990265229e-2, 1.22881444e-6],
	[3.561485983136586, 1.797648948023003e-2, 1.21518946e-6],
	[1.941975361869, -6.259843043363501e-4, 9.602856999999999e-7],
	[5.845244776759587, -2.743819348074506e-2, 1.17447177e-6],
	[1.821048365911, 9.460829229838182e-3, 1.05844105e-6],
	[7.58713545461e-1, 1.682177864988152e-4, 2.38314749e-6],
	[3.292891638604586, 4.573365667404765e-2, 7.6563038e-7],
	[3.766016108380586, 3.68314021517197e-2, 4.0758243e-7],
	[5.747244956219586, 9.954342722363187, 4.9623409e-7],
	[1.724062868741, -2.774017744689255e-2, 3.0030779e-7],
	[4.429747729642586, -8.904754331211824e-3, 2.6134164e-7],
	[8.65916190901e-1, 2.718340176462802e-2, 2.8919452e-7],
	[2.259603352363, -3.660152378331885e-2, 2.2137882e-7],
	[1.108725025984, 9.935732440466172, 2.4499503e-7],
	[1.680391963791, 9.076040299352415e-3, 1.6524166e-7],
]

const PHOBOS: MarsSatBody = {
	mu: 9.549547741038312e-11,
	l: 1.97020556283139e1,
	acc: 1.657852042683113e-10,
	constants: [0.0000626916188, 2.0912973926417302, -0.0000005774003141, 0.000000618505279, -0.0000575018919826, -0.0000540676493351],
	list: [PHOBOS_0, PHOBOS_1, PHOBOS_2, PHOBOS_3],
}

const DEIMOS: MarsSatBody = {
	mu: 9.54954762276812e-11,
	l: 4.9770138896523,
	acc: -2.331793571572226e-14,
	constants: [0.00015681340867, -1.9167537810740201, -0.0000239579419518, 0.0000257893300229, -0.0056443721379635, -0.005312180697856],
	list: [DEIMOS_0, DEIMOS_1, DEIMOS_2, DEIMOS_3],
}

const BODIES = [PHOBOS, DEIMOS] as const

const OME0 = 47.68143 * DEG2RAD
const INC0 = 37.1135 * DEG2RAD
const DOME = -0.1061 * DEG2RAD
const DINC = 0.0609 * DEG2RAD

// Computes the position and velocity of Phobos at given time using the MARSSAT model
export function phobos(time: Time) {
	return marssat(time, 0)
}

// Computes the position and velocity of Deimos at given time using the MARSSAT model
export function deimos(time: Time) {
	return marssat(time, 1)
}

// Computes the position and velocity of a given Mars' moon at given time using the MARSSAT model
export function marssat(time: Time, index: number) {
	time = tt(time)
	const t = time.day - (2451545 - 6491.5) + time.fraction

	const body = BODIES[index]
	const elem = new Float64Array(body.constants)

	for (let j = 0; j < 2; j++) {
		for (const [phase, frequency, amplitude] of body.list[j]) {
			const d = phase + t * frequency
			elem[j] += amplitude * Math.cos(d)
		}
	}

	for (let j = 2; j < 4; j++) {
		for (const [phase, frequency, amplitude] of body.list[j]) {
			const d = phase + t * frequency
			elem[2 * j - 2] += amplitude * Math.cos(d)
			elem[2 * j - 1] += amplitude * Math.sin(d)
		}
	}

	elem[1] += (body.l + body.acc * t) * t

	const pv = ellipticToRectangularA(body.mu, elem, 0)

	const k = (t - 6491.5) / DAYSPERJC
	const ome = OME0 + DOME * k
	const inc = INC0 + DINC * k
	const co = Math.cos(ome)
	const so = Math.sin(ome)
	const ci = Math.cos(inc)
	const si = Math.sin(inc)
	const m = [co, -ci * so, si * so, so, ci * co, -si * co, 0, si, ci] as const
	matMulVec(m, pv[0], pv[0])
	matMulVec(m, pv[1], pv[1])
	return pv
}
