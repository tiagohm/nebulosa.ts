import type { PositionAndVelocity } from './astrometry'
import { TAU } from './constants'
import { matMulVec } from './mat3'
import { pmod } from './math'
import { type Time, tt } from './time'
import type { MutVec3 } from './vec3'

// L1.2 theory of the galilan satellites,
// by Valery LAINEY, Alain VIENNE and Luc DURIEZ.
// https://ftp.imcce.fr/pub/ephem/satel/galilean/L1/L1.2

// Based on https://github.com/Stellarium/stellarium/blob/v25.3/src/core/planetsephems/l12.c

export type L12Term = readonly [number, number, number] // amplitude, phase, frequency

export interface L12Body {
	readonly mu: number
	readonly al: readonly [number, number]
	readonly a: readonly L12Term[]
	readonly l: readonly L12Term[]
	readonly z: readonly L12Term[]
	readonly zeta: readonly L12Term[]
}

const IO: L12Body = {
	mu: 0.282489428433814e-6,
	al: [0.1446213296021224e1, 0.35515522861824e1],
	a: [
		[0.0028210960212903, 0, 0],
		[0.0000000762024588, 0.36392902322306e1, 0.35644591656241e1],
		[0.0000000180900324, 0.99554707056522, 0.71289183312483e1],
		[0.0000000172337652, 0.18196487820921e1, 0.17822295777568e1],
		[0.000000010172608, 0.28150559763861e1, 0.89111478635073e1],
		[0.0000000094794086, 0.34760224933239e1, 0.80200331112799e1],
		[0.0000000092196266, 0.4634700495337e1, 0.10693377436209e2],
		[0.0000000058581604, 0.11586746335276e1, 0.26733443704266e1],
		[-0.0000000036218148, 0.23173675289588e1, 0.53466887181044e1],
		[0.0000000034892754, 0.17122470613669, 0.12475607079684e2],
		[0.0000000030842852, 0.36170311370435e1, 0.63501320826717e1],
		[0.000000002079465, 0.19906655633153e1, 0.14257836656755e2],
		[0.0000000013655244, 0.49369712857369e1, 0.1358483651814e-1],
		[0.0000000011682572, 0.57934065580556e1, 0.13366721796637e2],
		[-0.0000000008031976, 0.66879731833041, 0.16040066232595e2],
		[0.000000000730951, 0.56300556878949e1, 0.17822295806244e2],
		[0.0000000007014118, 0.43297377080515e1, 0.71002044886497e1],
		[0.0000000006561624, 0.43188797534991e1, 0.1303413843351e-1],
		[0.0000000005753088, 0.54252179509841e1, 0.95251981240076e1],
		[0.0000000004359548, 0.1167011088744e1, 0.19604525331797e2],
		[0.0000000003711992, 0.14936154077537e1, 0.1293892891234e-1],
		[-0.0000000003412576, 0.26346374300664e1, 0.1557111725796e-1],
		[0.000000000343298, 0.17994723387341e1, 0.3175066346181e1],
		[0.0000000003228344, 0.29861854159944e1, 0.21386754933987e2],
		[0.0000000003014418, 0.19871924348983, 0.2467531551031e-1],
		[0.000000000170767, 0.50718778620273e1, 0.35514255456604e1],
		[0.0000000001655832, 0.29783205832994e1, 0.44555739317536e1],
		[0.000000000161291, 0.48058392680935e1, 0.2316898452146e2],
		[0.0000000001527992, 0.18275651107267e1, 0.187134105996e2],
		[0.0000000001523312, 0.4632329727522e1, 0.44686092108182e1],
		[0.000000000144972, 0.19079860214667e1, 0.305065115332e-2],
		[0.0000000001188688, 0.53321680658912e1, 0.70987549449082e1],
		[0.0000000001129258, 0.9503149780442, 0.12700264165343e2],
		[0.0000000000986086, 0.3419094417858, 0.24951214111224e2],
		[-0.000000000087772, 0.36228267942948e1, 0.17958145576535e1],
		[0.0000000000857194, 0.33682834215727e1, 0.5973671126673e1],
		[-0.0000000000545492, 0.19473964103154e1, 0.2292942571804e-1],
		[0.0000000000326102, 0.24880420823571e1, 0.2511961071887e-1],
	],
	l: [
		[-0.0001925258348666, 0.49369589722645e1, 0.1358483658305e-1],
		[-0.0000970803596076, 0.43188796477322e1, 0.1303413843243e-1],
		[-0.00008988174165, 0.19080016428617e1, 0.305064867158e-2],
		[-0.0000553101050262, 0.14936156681569e1, 0.1293892891155e-1],
		[-0.000050358442615, 0.36410196089987e1, 0.35644591049605e1],
		[-0.0000444412770116, 0.18196478828985e1, 0.17822295777568e1],
		[0.000041807887049, 0.26346334480977e1, 0.155711172213e-1],
		[0.0000372356597388, 0.2140244090265e1, 0.145009774889e-2],
		[-0.0000234440533016, 0.19871945729267, 0.246753155074e-1],
		[-0.000016031316424, 0.28203470990931e1, 0.9519619e-4],
		[-0.0000119049755698, 0.99521552502799, 0.71289183312483e1],
		[-0.000010901426932, 0.11586742711973e1, 0.26733443704266e1],
		[0.0000087217118104, 0.22995085327344e1, 0.44456805185e-3],
		[0.0000082229455492, 0.84723690387904, 0.54980078903e-3],
		[0.000007536548172, 0.3064460324515e1, 0.64826749624e-3],
		[-0.0000061452803962, 0.28150499448772e1, 0.89111478635073e1],
		[-0.0000057575824778, 0.34760236756099e1, 0.80200331112799e1],
		[-0.0000053196302672, 0.14952058549171e1, 0.290012909923e-2],
		[-0.0000051181206936, 0.46347077042449e1, 0.10693377436209e2],
		[-0.0000047817413326, 0.49236512419835e1, 0.305548338778e-2],
		[0.0000045554015322, 0.19585097634352e1, 0.2292862594121e-1],
		[0.0000043204134698, 0.15842888614383e1, 0.1567711247819e-1],
		[0.0000037684098282, 0.23173652780077e1, 0.53466887181044e1],
		[-0.0000031403738248, 0.22184076281042e1, 0.2515548916551e-1],
		[0.0000024336535428, 0.85320650238886, 0.254269688344e-2],
		[-0.0000020289901692, 0.36168998565188e1, 0.63501320826717e1],
		[0.0000018665438704, 0.48458061649481e1, 0.1358967489813e-1],
		[-0.0000018552431038, 0.17086811529922, 0.12475607079684e2],
		[-0.0000016229875536, 0.62803206871082e1, 0.60414171604e-3],
		[-0.0000013160987604, 0.14718125754925e1, 0.1435846001232e-1],
		[0.0000008070729808, 0.38735416148641, 0.376586803791e-2],
		[0.0000002602397658, 0.14337589305551e1, 0.45692429208e-2],
	],
	z: [
		[0.0041510849668155, 0.4089939635545e1, -0.1290686414666e-1],
		[0.0006260521444113, 0.1446188898627e1, 0.35515522949802e1],
		[0.0000352747346169, 0.21256287034578e1, 0.12727416567e-3],
		[0.0000198194483636, 0.55835619926762e1, 0.3206575114e-4],
		[0.0000146399842989, 0.44137212696837, 0.266425335477e-2],
		[0.0000098749504021, 0.4507611878132, -0.35773660260022e1],
		[-0.0000096819265753, 0.59097266550442e1, 0.17693227079462e1],
		[-0.0000083063168209, 0.28751474873012, 0.87820791951527],
		[0.0000059689735869, 0.50740752477871e1, 0.71160118048918e1],
		[-0.000005222058869, 0.27460731023666e1, 0.67796100936e-3],
		[0.0000046538995236, 0.49143203339385e1, -0.53595956184347e1],
		[0.0000045951340101, 0.42533513770304e1, -0.44684808200578e1],
		[-0.0000037711061757, 0.54120093562773e1, -0.17951364445825e1],
		[0.0000037405126681, 0.30946737347297e1, -0.71418251640916e1],
		[0.0000022044764663, 0.54360702580001e1, -0.2649170024124e-1],
		[0.000001869830379, 0.41124042914226e1, -0.27985797954589e1],
		[-0.000001541037536, 0.27141931505529e1, 0.277312366799e-2],
		[0.0000013214613496, 0.1275017772353e1, -0.89240547799787e1],
		[-0.0000012707585609, 0.51141075152507e1, 0.37654227378982],
		[0.0000012193607962, 0.59977053365953e1, -0.985661699569e-2],
		[-0.0000011886104747, 0.32658350285168e1, 0.53337818460633e1],
		[0.0000008742035177, 0.23903528311144e1, 0.251949218188e-2],
		[-0.0000007689215742, 0.38308837306225e1, -0.272932255001e-2],
	],
	zeta: [
		[0.0003142172466014, 0.27964219722923e1, -0.2315096098e-2],
		[0.0000904169207946, 0.10477061879627e1, -0.56920638196e-3],
		[0.000017569539578, 0.24150809680215e1, 0],
		[0.0000164452324013, 0.33368861773902e1, -0.12491307197e-3],
		[0.0000055424829091, 0.59720202381027e1, -0.3056116472e-4],
		[0.0000035856270353, 0.84898736841329, -0.2524452190063e-1],
		[0.000002418076014, 0.55603770950923e1, 0.290036814458e-2],
		[-0.000000867308493, 0.28496686106299, -0.145005933532e-2],
		[-0.0000003176227277, 0.53834633036029e1, -0.234986322987e-1],
		[0.0000003152816608, 0.45569499027478e1, 0.43504654304e-2],
		[0.0000002338676726, 0.17633292120047e1, 0.145013391386e-2],
		[0.0000001754553689, 0.48429319984493e1, -0.2568881653244e-1],
		[0.0000001286319583, 0.57543347143871e1, -0.2581366097974e-1],
		[0.0000000967213304, 0.115035924269e1, -0.290014713978e-2],
		[0.000000000069231, 0.40745966852008e1, -0.3250675731907e-1],
	],
}

const EUROPA: L12Body = {
	mu: 0.282483274392893e-6,
	al: [-0.3735263437471362, 0.176932271112347e1],
	a: [
		[0.0044871037804314, 0, 0],
		[0.0000004324367498, 0.1819645606291e1, 0.17822295777568e1],
		[0.000000160361475, 0.43002726529577e1, 0.26733443704266e1],
		[-0.0000001019146786, 0.54589480865442e1, 0.53466887181044e1],
		[0.0000000924734786, 0.56222139048906e1, 0.89111478887838],
		[-0.00000005236658, 0.36392846323417e1, 0.35644591656241e1],
		[0.0000000511509, 0.29783307371014e1, 0.44555739317536e1],
		[-0.000000031190778, 0.99466557754027, 0.71289183312483e1],
		[-0.0000000272859938, 0.28144480309092e1, 0.89111478635073e1],
		[0.0000000232225828, 0.62608434364366e1, 0.2785672921155e1],
		[-0.000000018131077, 0.43188692380649e1, 0.1303413830886e-1],
		[0.0000000174960544, 0.16563941638726e1, 0.62378035398422e1],
		[-0.0000000122874072, 0.46421290370833e1, 0.10693377254218e2],
		[-0.000000009536713, 0.14936536615312e1, 0.1293892882069e-1],
		[-0.0000000084863836, 0.17146854643555, 0.12475607079684e2],
		[0.0000000071939342, 0.49376739095661e1, 0.1358483301703e-1],
		[0.0000000069122354, 0.62488746138492e1, 0.41785094280464e1],
		[0.0000000061377568, 0.33434976298081, 0.80200331112799e1],
		[-0.0000000045343054, 0.19892156959655e1, 0.14257836656755e2],
		[0.0000000044574684, 0.34597804303324, 0.35357692227539e1],
		[0.0000000042350072, 0.62719655202169e1, 0.13928364636651e1],
		[-0.0000000028783772, 0.3810881130261e1, 0.16040066232595e2],
		[0.0000000024354662, 0.99587190880214, 0.9041498929738],
		[0.000000002253294, 0.52958965893939e1, 0.98022627054664e1],
		[0.000000002157357, 0.6237905055963e1, 0.55713458670107e1],
		[-0.0000000016530062, 0.56456686036734e1, 0.17822294694543e2],
		[0.0000000016464798, 0.26346435392424e1, 0.1557111712676e-1],
		[0.0000000011589838, 0.32732388195745e1, 0.17691951440716e1],
		[-0.0000000010251826, 0.1907985853566e1, 0.305064978382e-2],
		[-0.000000001020351, 0.11692020351116e1, 0.19604525194172e2],
		[0.0000000007614982, 0.16862812414995e1, 0.3534296144323e1],
		[0.0000000007104494, 0.59112717191092e1, 0.24092214574831e1],
		[-0.0000000006957184, 0.24879412197796e1, 0.2511960973067e-1],
		[-0.0000000005817914, 0.19872303312324, 0.2467531551127e-1],
		[-0.0000000003792178, 0.15765189821595e1, 0.252444418302e-1],
		[0.0000000003397378, 0.58126953372535e1, 0.2597306713876e-1],
		[0.0000000003159492, 0.23545476741301e1, 0.2606827709955e-1],
		[0.0000000002538154, 0.19471441186087e1, 0.2292942491976e-1],
	],
	l: [
		[0.0008576433172936, 0.43188693178264e1, 0.1303413830805e-1],
		[0.0004549582875086, 0.14936531751079e1, 0.1293892881962e-1],
		[0.0003248939825174, 0.18196494533458e1, 0.17822295777568e1],
		[-0.0003074250079334, 0.49377037005911e1, 0.1358483286724e-1],
		[0.0001982386144784, 0.1907986905476e1, 0.305101212869e-2],
		[0.0001834063551804, 0.21402853388529e1, 0.145009789338e-2],
		[-0.0001434383188452, 0.5622214036663e1, 0.89111478887838],
		[-0.0000771939140944, 0.4300272437235e1, 0.26733443704266e1],
		[-0.0000632289777196, 0.26346392822098e1, 0.155711170847e-1],
		[0.0000446766477388, 0.54589448561143e1, 0.53466887181044e1],
		[0.000043657473141, 0.36392908617709e1, 0.35644591656241e1],
		[0.0000349172750296, 0.28289867162553e1, 0.2988574915e-4],
		[-0.0000325709094646, 0.5372140978023e1, 0.12495233774e-3],
		[0.000020582647386, 0.15258464215508e1, 0.290013155222e-2],
		[-0.0000192706087556, 0.29783311531879e1, 0.44555739317536e1],
		[0.0000168028316254, 0.24879414119403e1, 0.2511960972565e-1],
		[-0.0000141628733606, 0.29183576504413e1, 0.64930403718e-3],
		[0.00001407131556, 0.19872319369353, 0.2467531551031e-1],
		[0.000013194691576, 0.99584744364935, 0.71289183312483e1],
		[0.000010659861762, 0.53356907396678e1, 0.302332192319e-2],
		[-0.0000104011727738, 0.62608296198866e1, 0.2785672921155e1],
		[0.0000100746080234, 0.44288900030073e1, 0.55297871931e-3],
		[0.0000097414019416, 0.27312462188296e1, 0.89111510230745e1],
		[-0.000009465136664, 0.25010358163865e1, 0.9347832247e-4],
		[0.0000091108073324, 0.15765182522628e1, 0.2524444168212e-1],
		[-0.0000087720567668, 0.15376962386886e1, 0.1567639331507e-1],
		[-0.000007842970334, 0.58128473756772e1, 0.2597306924635e-1],
		[-0.0000075566039418, 0.3058625168892e1, 0.43252872559e-3],
		[-0.0000066580990752, 0.1959127059339e1, 0.2292856741249e-1],
		[-0.0000065854142774, 0.1861767333764e1, 0.2609305838467e-1],
		[-0.000005813113523, 0.16563893807978e1, 0.62378035398422e1],
		[0.0000055720865276, 0.39565695752204e1, 0.254812163399e-2],
		[-0.0000048198508906, 0.62720230965345e1, 0.13928364605775e1],
		[0.0000042728431266, 0.46220912946918e1, 0.10693377982182e2],
		[0.0000042175545304, 0.13509343368359e1, 0.301644357878e-2],
		[0.000003770762452, 0.51034507119889e1, 0.2521965820225e-1],
	],
	z: [
		[-0.0093589104136341, 0.40899396509039e1, -0.1290686414666e-1],
		[0.0002988994545555, 0.59097265185595e1, 0.17693227079462e1],
		[0.000213903639035, 0.21256289300016e1, 0.12727418407e-3],
		[0.0001980963564781, 0.2743516829265e1, 0.67797343009e-3],
		[0.0001210388158965, 0.55839943711203e1, 0.320566149e-4],
		[0.0000837042048393, 0.16094538368039e1, -0.90402165808846],
		[0.0000823525166369, 0.14461887708689e1, 0.35515522949802e1],
		[-0.000031590653282, 0.28751224400811, 0.87820791951527],
		[-0.0000294503681314, 0.45078002968967, -0.35773660260022e1],
		[-0.0000278946698536, 0.22704374310903e1, -0.17951364497113e1],
		[0.0000144958688621, 0.29313956641719e1, -0.2686251242239e1],
		[0.0000139052321679, 0.60542576187622e1, -0.259410024045e-1],
		[0.000010837443135, 0.59320761116863e1, -0.10163502160128e1],
		[-0.0000082175838585, 0.49144730088838e1, -0.53595956184347e1],
		[0.0000073925894084, 0.25962855881215e1, -0.2584579292787e-1],
		[0.0000062618381566, 0.62252936384007e1, -0.71418248393794e1],
		[-0.0000051968296512, 0.54353355159239e1, -0.2649169672504e-1],
		[-0.0000043507065743, 0.51150292346242e1, 0.37654221060604],
		[0.0000042081682285, 0.31202613836361e1, 0.44427230757158e1],
		[0.000004129826697, 0.42533371370636e1, -0.44684808200578e1],
		[-0.000003699122193, 0.5248756417239e1, 0.26604375002057e1],
		[-0.0000027357551003, 0.12734806685602e1, -0.89240546532297e1],
		[-0.0000026854901206, 0.75596663258784, 0.1580695318046e-1],
		[0.0000023074479953, 0.19438998534712e1, 0.71160114825227e1],
		[0.000002016344505, 0.58484195254467e1, -0.24091843401454e1],
		[-0.0000018506530067, 0.26838225102582e1, 0.68236609075e-3],
		[0.0000018159137522, 0.26048690461733e1, 0.62248966818788e1],
		[-0.0000017894118824, 0.57385537790777e1, -0.10706284328884e2],
		[0.000001651886452, 0.32658492478888e1, 0.53337818460633e1],
		[-0.0000015660692561, 0.61789350505156e1, -0.1145358884796e-1],
		[0.0000014426949422, 0.60014075911383e1, -0.17664769149811e1],
		[0.0000013196935928, 0.55753025652974e1, -0.62507103665413e1],
		[-0.0000011726743714, 0.5024293274765e1, -0.1435121070414e-1],
		[-0.0000009550285338, 0.28409403047363e1, 0.142575950449e-2],
		[-0.0000007569857746, 0.38098760906143e1, -0.272716277938e-2],
		[-0.0000007495662748, 0.29896372346394e1, 0.200975532439e-2],
		[0.0000007091149133, 0.27139331814919e1, -0.199249327833e-2],
		[0.0000005646670312, 0.21683602575236e1, -0.1287180323294e-1],
		[-0.0000002004455524, 0.12893849410519e1, -0.327249234778e-2],
		[-0.0000001623489363, 0.24189454629613, 0.446093376788e-2],
		[0.0000001058862562, 0.45356953407129e1, 0.392699081721e-2],
	],
	zeta: [
		[0.0040404917832303, 0.10477063169425e1, -0.5692064054e-3],
		[0.0002200421034564, 0.33368857864364e1, -0.12491307307e-3],
		[0.0001662544744719, 0.24134862374711e1, 0],
		[0.0000590282470983, 0.59719930968366e1, -0.3056160225e-4],
		[-0.00001050303314, 0.27964978379152e1, -0.231509661238e-2],
		[-0.000010294324825, 0.8489879632215, -0.2524452190165e-1],
		[0.000007260001302, 0.55603730312676e1, 0.290036767131e-2],
		[0.0000018391258758, 0.28480515491153, -0.145005791969e-2],
		[0.0000014880605763, 0.48429974929766e1, -0.2568881513871e-1],
		[-0.0000008828196274, 0.65011185407635, 0.346961706831e-2],
		[0.0000008714042768, 0.17639430319108e1, 0.145013521576e-2],
		[0.0000008536188044, 0.45568506666427e1, 0.435046414101e-2],
		[0.0000006846214331, 0.57542117253981e1, -0.2581376870263e-1],
		[0.0000004471826348, 0.5383469432152e1, -0.2349863236637e-1],
		[0.0000003034392168, 0.2207820131518e1, -0.2578317090602e-1],
		[0.0000001799083735, 0.31858868501531e1, 0.88086056517e-3],
		[-0.0000001792048645, 0.51949494917342e1, -0.201932369319e-2],
		[-0.0000001098546626, 0.59286821904995e1, 0.491973165797e-2],
		[-0.0000001083128732, 0.45808061408794e1, -0.59959459406e-3],
		[0.0000001062153531, 0.38387102863271e1, -0.53795085847e-3],
		[0.0000000768496749, 0.3555376872977e1, 0.580055878127e-2],
		[-0.0000000692273841, 0.46440611341931e1, 0.302532190292e-2],
		[0.0000000676969224, 0.13621319661456, -0.44430413602e-3],
		[-0.0000000621559952, 0.3009349717995e1, -0.1360328720069e-1],
		[0.0000000000608298, 0.405295695326e1, -0.3251086990094e-1],
	],
}

const GANYMEDE: L12Body = {
	mu: 0.282498184184723e-6,
	al: [0.2874089391143348, 0.878207923589328],
	a: [
		[0.0071566594572575, 0, 0],
		[0.000001393029911, 0.11586745884981e1, 0.26733443704266e1],
		[0.0000006449829346, 0.56222145702102e1, 0.89111478887838],
		[0.000000229805952, 0.12995924044108e1, 0.10034433456729e1],
		[-0.000000122143437, 0.49612436330515e1, 0.17822295777568e1],
		[0.0000001095798176, 0.1948670877835e1, 0.15051650461529e1],
		[0.0000000701435616, 0.64978508114196, 0.50172166963138],
		[0.0000000547868566, 0.25992050672074e1, 0.20068866945508e1],
		[-0.0000000394635858, 0.23173535605652e1, 0.53466887181044e1],
		[-0.0000000363221428, 0.36393008632056e1, 0.35644591656241e1],
		[0.0000000290949364, 0.20123392230605e1, 0.17535157350384e1],
		[0.0000000281244968, 0.32490010762048e1, 0.25086083721948e1],
		[-0.0000000207924698, 0.29783308899923e1, 0.44555739317536e1],
		[0.0000000146896774, 0.38988244013504e1, 0.30103300418262e1],
		[-0.0000000119930042, 0.16563968316083e1, 0.62378035398422e1],
		[0.000000011206746, 0.43188665692819e1, 0.1303413828534e-1],
		[-0.0000000109535132, 0.49372826282154e1, 0.1358483493794e-1],
		[0.0000000099867772, 0.96700720263958, 0.62699633776977],
		[0.000000007766826, 0.45486373016444e1, 0.35120517182683e1],
		[0.0000000074143972, 0.16140449852661, 0.12531361661566],
		[0.0000000066346638, 0.3344107353601, 0.80200331112799e1],
		[0.0000000057842684, 0.14936630646671e1, 0.1293892879937e-1],
		[-0.0000000055768352, 0.44651777597613e1, 0.1128738614471e1],
		[-0.0000000049395106, 0.61563894598809e1, 0.17520662093793e1],
		[0.0000000041439704, 0.51984558307998e1, 0.40137734147421e1],
		[-0.000000004076563, 0.99543742426922, 0.71289183312483e1],
		[-0.0000000036862062, 0.46386836178626e1, 0.10693377254218e2],
		[0.0000000033617538, 0.37493658441448e1, 0.87808669180168],
		[0.0000000033348284, 0.2266819681899e1, 0.16304394485673e1],
		[-0.0000000025754698, 0.33293196902303, 0.17952648120307e1],
		[0.0000000024363084, 0.19604838407749e1, 0.11232854513197],
		[0.0000000022265432, 0.58482745704418e1, 0.45154950951905e1],
		[0.0000000020032676, 0.29166648062069e1, 0.21321610765333e1],
		[-0.0000000018115706, 0.99782757414001, 0.90414978368384],
		[0.0000000014535006, 0.187482120416e1, 0.89112137093506e1],
		[-0.000000000681926, 0.19871670124324, 0.2467531549383e-1],
		[0.0000000004433776, 0.24880003003965e1, 0.2511961019665e-1],
		[-0.0000000002836658, 0.58126277034761e1, 0.2597306860752e-1],
	],
	l: [
		[0.0002310797886226, 0.21402987195942e1, 0.145009784384e-2],
		[-0.0001828635964118, 0.43188672736968e1, 0.1303413828263e-1],
		[0.0001512378778204, 0.49373102372298e1, 0.1358483481252e-1],
		[-0.0001163720969778, 0.4300265986149e1, 0.26733443704266e1],
		[-0.0000955478069846, 0.14936612842567e1, 0.1293892879857e-1],
		[0.0000815246854464, 0.56222137132535e1, 0.89111478887838],
		[-0.0000801219679602, 0.12995922951532e1, 0.10034433456729e1],
		[-0.0000607017260182, 0.64978769669238, 0.50172167043264],
		[0.0000543922473002, 0.27927547440639e1, 0.298808737e-4],
		[-0.0000489253646474, 0.53711728089803e1, 0.12495278292e-3],
		[-0.0000427574981536, 0.18196513407448e1, 0.17822295777568e1],
		[-0.0000307360417826, 0.19498372703786e1, 0.15051650064903e1],
		[-0.0000169767346458, 0.19078637281659e1, 0.305076782267e-2],
		[0.0000154725890508, 0.56912713028984e1, 0.65164073556e-3],
		[-0.0000145268863648, 0.18863875475387, 0.12530827181195],
		[-0.0000135654458738, 0.27930238268852e1, 0.55663681407e-3],
		[-0.0000134648621904, 0.25991972928128e1, 0.20068866945508e1],
		[0.000009552401732, 0.23173520454449e1, 0.53466887181044e1],
		[0.000008795512517, 0.36393024031096e1, 0.35644591656241e1],
		[0.000007546200363, 0.53560617584395e1, 0.9242697749e-4],
		[-0.0000071146195958, 0.20120561622463e1, 0.17535157644008e1],
		[0.0000064153141218, 0.15526366820734e1, 0.290013097324e-2],
		[-0.0000063221625942, 0.32490122452649e1, 0.25086083721948e1],
		[-0.0000056564973024, 0.24862139082596e1, 0.44834622386e-3],
		[0.000005257024572, 0.19871532348033, 0.2467531550158e-1],
		[0.0000047020767994, 0.2978331779063e1, 0.44555739317536e1],
		[-0.000004700422947, 0.96617050453708, 0.62699712737505],
		[-0.000004656519882, 0.36125113449716e1, 0.4363323134e-3],
		[-0.0000042349322008, 0.19604744669606e1, 0.11232854282257],
		[-0.0000038755741918, 0.22619624763183e1, 0.2514666393973e-1],
		[-0.0000032577733688, 0.56861827246039e1, 0.170745765016e-2],
	],
	z: [
		[0.0014289811307319, 0.21256295942739e1, 0.12727413029e-3],
		[0.000771093122676, 0.55836330003496e1, 0.320643411e-4],
		[0.0005925911780766, 0.40899396636448e1, -0.1290686414666e-1],
		[0.0002045597496146, 0.52713683670372e1, -0.12523544076106],
		[0.0001785118648258, 0.28743156721063, 0.8782079244252],
		[0.0001131999784893, 0.14462127277818e1, 0.35515522949802e1],
		[-0.000065877816921, 0.22702423990985e1, -0.17951364394537e1],
		[0.0000497058888328, 0.59096792204858e1, 0.17693227129285e1],
		[-0.0000316384926978, 0.16093054939404e1, -0.90402165028424],
		[0.0000287801237327, 0.46217321268757e1, -0.6269571234184],
		[-0.0000181744317896, 0.5921064137936e1, 0.37648623991673],
		[0.0000105558175161, 0.39720191398746e1, -0.11286788041058e1],
		[-0.0000070808673396, 0.60542548894164e1, -0.2594100241521e-1],
		[-0.000007080440402, 0.27978433776854e1, 0.67774258703e-3],
		[-0.0000061046181888, 0.14151685760988e1, -0.87530769416913],
		[-0.0000057610853129, 0.42530537622646e1, -0.44684807882788e1],
		[-0.0000057310334964, 0.29311803223072e1, -0.26862512192699e1],
		[0.0000048299146941, 0.27138294508149e1, 0.277313296719e-2],
		[0.0000046610005483, 0.33222980229554e1, -0.16304004832039e1],
		[-0.0000038142769361, 0.25962943627643e1, -0.2584579295551e-1],
		[0.000003498241733, 0.15866568011217e1, 0.18816512920593e1],
		[-0.0000030091617315, 0.35921173988567e1, -0.35773660056343e1],
		[-0.0000024732926446, 0.53461730094807e1, 0.25122576835111],
		[0.0000024416432533, 0.47049477027963e1, -0.25049613834712],
		[0.0000024171568015, 0.34508032389167e1, 0],
		[0.0000023143850535, 0.55385759257808e1, 0.286833390288e-2],
		[0.0000022651772374, 0.55608006706192e1, 0.145018929678e-2],
		[0.000002224769556, 0.26725424635341e1, -0.21321221654766e1],
		[0.0000020947921969, 0.22350374116258e1, 0.23833730192673e1],
		[-0.0000014042712722, 0.93718044411525, 0.13799296041822e1],
		[0.0000011932531874, 0.28861941414418e1, 0.28850946416201e1],
		[-0.000001118038924, 0.49139919849718e1, -0.5359595572717e1],
		[0.000001107638451, 0.20227538540345e1, -0.26338438454332e1],
		[-0.0000010371714944, 0.40722739402948, -0.87385759089274],
		[-0.0000008993128501, 0.3094269188353e1, -0.71418251640916e1],
		[0.000000726838142, 0.54334774230433e1, -0.2649168789655e-1],
		[-0.0000007178049665, 0.52487423493616e1, 0.26604375002057e1],
		[0.0000006908412319, 0.40596134184175e1, -0.75221793556997],
		[-0.000000678415157, 0.38846818226669e1, 0.424965355344e-2],
		[0.000000677231492, 0.23013479896873e1, 0.26317235358158e1],
		[0.0000006659820028, 0.3535953029555e1, 0.3386816325851e1],
		[-0.0000006339665249, 0.39268665697903e1, 0.44426670658559e1],
		[-0.0000006286307601, 0.19440608894162e1, 0.71160114019304e1],
		[-0.0000006128705113, 0.25027415074658e1, 0.62249001971556e1],
		[0.0000005660807396, 0.13729316457251e1, -0.31355655165873e1],
		[-0.0000005206551413, 0.55749300982469e1, -0.62507103665413e1],
		[-0.0000004718481418, 0.45366605084874e1, 0.16786677353e-3],
		[-0.0000004583970422, 0.19351070248496e1, -0.981516955745e1],
		[-0.0000004577854173, 0.62350780976534e1, 0.17563373058434e1],
		[0.000000346602966, 0.75412427489767, 0.158070974957e-1],
	],
	zeta: [
		[0.0015932721570848, 0.33368862796665e1, -0.12491307058e-3],
		[0.0008533093128905, 0.24133881688166e1, 0],
		[0.0003513347911037, 0.59720789850127e1, -0.3056101771e-4],
		[-0.0001441929255483, 0.10477061764435e1, -0.56920632124e-3],
		[0.000015730352775, 0.55604041197704e1, 0.290036650112e-2],
		[0.0000025161319881, 0.28477653709685, -0.145005544868e-2],
		[0.0000020438305183, 0.17652628559998e1, 0.145013839265e-2],
		[0.0000017939612784, 0.45568977341583e1, 0.435046215904e-2],
		[0.0000013614276895, 0.84898872627945, -0.2524452190063e-1],
		[-0.0000008996109017, 0.4644115600334e1, 0.302532145883e-2],
		[-0.000000870207843, 0.27972000093551e1, -0.231509656451e-2],
		[-0.0000004371144064, 0.48429530385679e1, -0.256888160115e-1],
		[-0.0000002174259374, 0.57543785603741e1, -0.2581364299331e-1],
		[-0.0000001926397869, 0.20118539705648e1, 0.293305968645e-2],
		[0.0000001589279656, 0.35554727018503e1, 0.580055777684e-2],
		[-0.0000001432228753, 0.11966574544002e1, -0.157501249838e-2],
		[-0.0000000926213408, 0.22052538606469e1, -0.2578279742602e-1],
		[0.0000000000106902, 0.45764213311755e1, -0.326116147168e-1],
	],
}

const CALLISTO: L12Body = {
	mu: 0.282492144889909e-6,
	al: [-0.3620341291375704, 0.376486233433828],
	a: [
		[0.0125879701715314, 0, 0],
		[0.000003595204947, 0.64965776007116, 0.50172168165034],
		[0.0000027580210652, 0.1808423578151e1, 0.31750660413359e1],
		[0.0000012874896172, 0.62718908285025e1, 0.13928364698403e1],
		[-0.0000004173729106, 0.12990650292663e1, 0.10034433697108e1],
		[0.0000002790757718, 0.71428870045577, 0.7500722586913],
		[-0.0000001998252258, 0.19489881012004e1, 0.15051650461529e1],
		[-0.0000001001149838, 0.25987168731338e1, 0.20068867266014e1],
		[-0.0000000513967092, 0.32484798706247e1, 0.25086084022422e1],
		[-0.0000000475687992, 0.48635521917696e1, 0.74862216593606],
		[0.000000034824224, 0.15082713497295, 0.37645917070525],
		[0.000000028384063, 0.51672973364888e1, 0.12530678073049],
		[-0.0000000263234638, 0.33499822210495e1, 0.30103491232578e1],
		[0.0000000239106346, 0.43573519442736e1, 0.62698238798737],
		[0.0000000219977422, 0.15075404808879e1, 0.27986109086768e1],
		[-0.0000000171144478, 0.62607361864777e1, 0.27856729335053e1],
		[-0.0000000141956834, 0.4548107771891e1, 0.35120517575303e1],
		[-0.000000012000363, 0.18583887479127e1, 0.11287042579152e1],
		[0.0000000108418904, 0.54873138800427e1, 0.67395238593127e1],
		[0.0000000108218254, 0.59772630516669e1, 0.10163811590412e1],
		[0.0000000002477642, 0.56894071957878e1, 0.65165021654e-3],
		[-0.0000000001874576, 0.28598333265121e1, 0.55639542661e-3],
	],
	l: [
		[0.0005586040123824, 0.21404207189815e1, 0.145009793231e-2],
		[-0.0003805813868176, 0.27358844897853e1, 0.2972965062e-4],
		[0.0002205152863262, 0.649796525964, 0.5017216724358],
		[0.0001877895151158, 0.18084787604005e1, 0.31750660413359e1],
		[0.0000766916975242, 0.62720114319755e1, 0.13928364636651e1],
		[0.0000747056855106, 0.12995916202344e1, 0.10034433456729e1],
		[-0.0000388323297366, 0.71289234751879, 0.75007236972328],
		[0.0000335036484314, 0.53712641184981e1, 0.12494011725e-3],
		[0.0000293032677938, 0.19493939340593e1, 0.15051650209131e1],
		[0.0000185940935472, 0.14630998372377e1, 0.290013394052e-2],
		[-0.0000170438022886, 0.56893382353856e1, 0.65165044781e-3],
		[0.0000151393833114, 0.28749516044614e1, 0.55646069067e-3],
		[-0.0000148825637256, 0.3332107461884e1, 0.12530790075011],
		[0.0000129927896682, 0.25991973549465e1, 0.20068866945508e1],
		[-0.0000116117398772, 0.56192268627131e1, 0.9316625672e-4],
		[0.0000066211702894, 0.48564958193206e1, 0.74862286166569],
		[0.0000065387442486, 0.35580120361824e1, 0.165505137419e-2],
		[0.000006158079814, 0.32490037889701e1, 0.25086083721948e1],
		[0.0000046797140778, 0.96612169919707, 0.62699716616712],
	],
	z: [
		[0.0073755808467977, 0.55836071576084e1, 0.3206509914e-4],
		[0.0002065924169942, 0.59209831565786e1, 0.37648624194703],
		[0.0001589869764021, 0.28744006242623, 0.8782079244252],
		[-0.0001561131605348, 0.21257397865089e1, 0.12727441285e-3],
		[0.0001486043380971, 0.14462134301023e1, 0.35515522949802e1],
		[0.0000635073108731, 0.59096803285954e1, 0.17693227129285e1],
		[0.0000599351698525, 0.41125517584798e1, -0.27985797954589e1],
		[0.0000540660842731, 0.55390350845569e1, 0.286834082283e-2],
		[-0.0000489596900866, 0.46218149483338e1, -0.62695712529519],
		[0.0000333682283528, 0.5206697523888e1, -0.37358601734497],
		[0.0000295832427279, 0.59322697896516e1, -0.10163502275209e1],
		[0.0000292325461337, 0.52707623402008e1, -0.12523542448602],
		[0.0000197588369441, 0.33317768022759e1, 0],
		[-0.0000183551029746, 0.39720443249757e1, -0.11286788041058e1],
		[0.0000090411191759, 0.55606719963947e1, 0.145018374908e-2],
		[-0.0000081987970452, 0.33223313720086e1, -0.16304004832039e1],
		[-0.0000060406575087, 0.13970265485562e1, 0.431918320323e-2],
		[0.0000056895636122, 0.4199095666812e1, -0.3721359265672],
		[-0.0000040434854859, 0.47008406172134e1, -0.25049602889288],
		[-0.0000039403527376, 0.26725832255243e1, -0.21321221654766e1],
		[0.0000036901291978, 0.35207772267753, 0.11265585018525e1],
		[-0.0000028551622596, 0.55601265129356e1, -0.3158488614e-4],
		[-0.0000026588026505, 0.25969882784477, 0.141820255533e-2],
		[-0.0000019711212463, 0.20228019680496e1, -0.26338438454332e1],
		[0.0000019322089806, 0.51418595457408e1, 0.25123117908847],
		[-0.0000018673159813, 0.93674892088247, 0.13799296163047e1],
		[0.0000016838424078, 0.60796033426941e1, 0.75294520843775],
		[-0.0000016695689644, 0.15867810488422e1, 0.18816512864243e1],
		[0.0000016317841395, 0.45789534393209e1, 0.14822429153e-2],
		[-0.0000016159095087, 0.30157253757329, -0.141802844479e-2],
		[-0.0000014034621874, 0.59433512039442e1, -0.24091866865037e1],
		[-0.0000012029942283, 0.2713775488027e1, 0.277313730929e-2],
		[-0.0000011758260607, 0.40581098970285e1, -0.75221789504525],
		[-0.0000010798624964, 0.22364861319452e1, 0.23833729650229e1],
		[-0.0000010108880552, 0.13729872033949e1, -0.31355655165873e1],
		[-0.0000008876681807, 0.5053410761501e1, -0.50169281575682],
		[0.0000008869382117, 0.50147420853991e1, 0.68353864231e-3],
		[-0.0000008194699011, 0.62190878357566e1, -0.37503615934219],
		[0.0000007093782158, 0.44118312641559e1, -0.24221246131672e1],
		[0.0000006728737059, 0.3191001606292e1, -0.37068584881726],
		[0.0000006297345982, 0.13595719733984e1, 0.11251084135564e1],
		[0.0000006128899757, 0.5140216129929e1, 0.71160095483087e1],
		[-0.0000005580987049, 0.3411773310901e1, -0.12539396666771e1],
		[0.0000005321318002, 0.35377046967957e1, 0.576853402713e-2],
		[-0.0000004739086661, 0.21645217929478e1, 0.58845474482e-3],
		[0.0000004518928658, 0.44963664372727e1, 0.290233251112e-2],
	],
	zeta: [
		[0.0038422977898495, 0.24133922085557e1, 0],
		[0.0022453891791894, 0.59721736773277e1, -0.3056125525e-4],
		[-0.0002604479450559, 0.33368746306409e1, -0.12491309972e-3],
		[0.000033211214323, 0.55604137742337e1, 0.290037688507e-2],
		[0.0000049727136261, 0.2848822970682, -0.145005717619e-2],
		[-0.0000049416729114, 0.10476908456459e1, -0.56920298857e-3],
		[0.0000043945193428, 0.17684273746003e1, 0.145013445247e-2],
		[0.0000037630501589, 0.45567680530533e1, 0.43504645407e-2],
		[-0.000003082341875, 0.20094360655956e1, 0.293130513767e-2],
		[0.0000004719790711, 0.18055417618741e1, 0.14195445432e-2],
		[-0.0000004637177865, 0.38277528822158e1, -0.148087310016e-2],
		[0.0000003497224175, 0.46444360330108e1, 0.302531301623e-2],
		[-0.0000003467132626, 0.10120757927163e1, 0.438161268229e-2],
		[0.000000332441257, 0.35549391686606e1, 0.580053790321e-2],
		[0.0000001945374351, 0.6125168715086e1, 0.288082648728e-2],
		[0.0000001727743329, 0.1190077323661e1, -0.290010685247e-2],
		[-0.0000001485176585, 0.62335834706368e1, 0.148076790927e-2],
		[0.0000000000666922, 0.40616225761771e1, -0.3272492347489e-1],
	],
}

const BODIES = [IO, EUROPA, GANYMEDE, CALLISTO] as const

// const VSOP87 = [9.994327815023905713e-1, 3.039550993390781261e-2, -1.449924943755843383e-2, -3.08977044222367188e-2, 9.988822846893227815e-1, -3.577028369016394015e-2, 1.339578739122566807e-2, 3.619798764705610479e-2, 9.992548516622136737e-1] as const
const J2000 = [0.9994327730319685, 0.030395736820722188, -0.01449935766698494, -0.033676879155137895, 0.9020579145791894, -0.43029918261067407, -3.689877119128493e-10, 0.43054339842595357, 0.9025698765590566] as const

// Computes the position and velocity of Io at given time using the L1 theory
export function io(time: Time) {
	return compute(time, 0)
}

// Computes the position and velocity of Europa at given time using the L1 theory
export function europa(time: Time) {
	return compute(time, 1)
}

// Computes the position and velocity of Ganymede at given time using the L1 theory
export function ganymede(time: Time) {
	return compute(time, 2)
}

// Computes the position and velocity of Callisto at given time using the L1 theory
export function callisto(time: Time) {
	return compute(time, 3)
}

// Computes the position and velocity of a given Jupiter's moon at given time using the L1 theory
export function compute(time: Time, index: number): PositionAndVelocity {
	time = tt(time)
	const t = time.day - 2433282 + (time.fraction - 0.5)
	const elem = new Float64Array(6)
	const sat = BODIES[index]

	for (const [amplitude, phase, frequency] of sat.a) {
		const arg = phase + frequency * t
		elem[0] += amplitude * Math.cos(arg)
	}

	elem[1] = sat.al[0] + sat.al[1] * t

	for (const [amplitude, phase, frequency] of sat.l) {
		const arg = phase + frequency * t
		elem[1] += amplitude * Math.sin(arg)
	}

	elem[1] = pmod(elem[1], TAU)

	for (const [amplitude, phase, frequency] of sat.z) {
		const arg = phase + frequency * t
		elem[2] += amplitude * Math.cos(arg)
		elem[3] += amplitude * Math.sin(arg)
	}

	for (const [amplitude, phase, frequency] of sat.zeta) {
		const arg = phase + frequency * t
		elem[4] += amplitude * Math.cos(arg)
		elem[5] += amplitude * Math.sin(arg)
	}

	const [a, al, k, h, q, p] = elem

	const an = Math.sqrt(sat.mu / a ** 3)
	let ee = al + k * Math.sin(al) - h * Math.cos(al)
	let de = 0

	do {
		const ce = Math.cos(ee)
		const se = Math.sin(ee)
		de = (al - ee + k * se - h * ce) / (1 - k * ce - h * se)
		ee = ee + de
	} while (Math.abs(de) > 1e-12)

	const ce = Math.cos(ee)
	const se = Math.sin(ee)
	const dle = h * ce - k * se
	const rsam1 = -k * ce - h * se
	const asr = 1 / (1 + rsam1)
	const phi = Math.sqrt(1 - k * k - h * h)
	const psi = 1 / (1 + phi)
	const x1 = a * (ce - k - psi * h * dle)
	const y1 = a * (se - h + psi * k * dle)
	const vx1 = an * asr * a * (-se - psi * h * rsam1)
	const vy1 = an * asr * a * (ce + psi * k * rsam1)
	const f2 = 2 * Math.sqrt(1 - q * q - p * p)
	const p2 = 1 - 2 * p * p
	const q2 = 1 - 2 * q * q
	const pq = 2 * p * q

	const pxyz: MutVec3 = [x1 * p2 + y1 * pq, x1 * pq + y1 * q2, (q * y1 - x1 * p) * f2]
	const vxyz: MutVec3 = [vx1 * p2 + vy1 * pq, vx1 * pq + vy1 * q2, (q * vy1 - vx1 * p) * f2]

	matMulVec(J2000, pxyz, pxyz)
	matMulVec(J2000, vxyz, vxyz)

	return [pxyz, vxyz]
}
